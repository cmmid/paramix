---
title: "Introductory Usage"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introductory Usage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(YLLr)
library(ggplot2)
library(data.table)
library(wpp2019)
```

The `YLLr` package provides convenient methods to both (1) properly aggregate age-dependent empirical relationships for use in compartmental ODE models with age groups and (2) properly disaggregate outcomes for those groups back to higher resolution by-age values.

The quintessential example is a years-life-lost analysis for a disease that has a highly age-specific mortality rate, such as COVID-19.

Considering the infection-fatality ratio for COVID-19 as found by Levin et al (TODO citation):

```{r}
ifr_levin <- \(age_in_years) {
  scaled <- exp(-7.56 + 0.121 * age_in_years)
  100 * scaled / (100 + scaled) / 100
}
dt <- data.table(age = 0:100)
dt[, ifr := ifr_levin(age)]
ggplot(dt) + aes(age, ifr) +
  geom_line() + scale_x_continuous("Age") + scale_y_continuous("Infection Fatality Ratio", trans = "log10") +
  theme_minimal()
```

Typically in ODE compartmental models, age groups will be represented at a lower resolution consistent with available data on, for example, contact patterns. For this example, if we want to get the relative mortality of these groups right, we need to properly aggregate those infection fatality ratios.

The challenge here is that generally $E[f(x)] \ne f(E[x])$, though it is commonly assumed that these are close enough. Further complication: different populations also have different age pyramids. Let's compare a few versions of getting this value "right":

 - using the average age in the formula
 - using the formula average, without accounting for actual age-distribution
 - using the age-weighted formula average

We'll assume an ODE model that has 5-year age bands and then an "85+" group, and for two characteristic population distribution: the UK, with a relatively flat age pyramid typifying high-income settings, and XYZ, with a generally much younger population typifying low-income settings.

```{r}
data('popF'); data('popM')
pop_data <- data.table(rbind(cbind(popF[grepl('United Kingdom',popF$name) | grepl('Afghanistan',popF$name), c('name','age',2020)],source='Females'),
                  cbind(popM[grepl('United Kingdom',popM$name) | grepl('Afghanistan',popM$name), c('name','age',2020)],source='Males')))
pop_data[source=='Males', `2020` := -pop_data[source=='Males']$`2020`]
pop_data$age <- factor(pop_data$age, levels=unique(pop_data$age))
ggplot(pop_data,
       aes(x = age, y = `2020`/1000, fill = source)) +
  geom_bar(position='stack',stat='identity') + labs(fill='') +
  xlab('Age group') + coord_flip() + scale_fill_brewer(palette='Set1') +
  facet_wrap(.~name,nrow=2,scales='fixed') + ylab('Population (millions)') + theme_bw() +
  scale_y_continuous(labels=function(x) abs(x)) + 
  theme(text=element_text(size=14))

model_agegrps <- c(5,20,65)
ex_data <- data.table(age=0:100)
ex_data[,age_group := 1+(age>=model_agegrps[1])+(age>=model_agegrps[2])+(age>=model_agegrps[3])]
mid_ages <- ex_data[, .(mid_age = mean(age)), by='age_group']
ex_data <- ex_data[mid_ages, on='age_group']
ex_data[, mort_of_mean:=ifr_levin(mid_age)]
ex_data[, mort_rate:=ifr_levin(age)]
means <- ex_data[, .(mean_of_mort = mean(mort_rate)), by=c('age_group')]
ex_data <- ex_data[means, on='age_group']
ggplot(ex_data) + 
  geom_line(aes(age,mort_rate)) + 
  geom_line(aes(age,mort_of_mean),col=2,lty=2) + 
  geom_line(aes(age,mean_of_mort),col=3,lty=2) + 
  ylab('Infection fatality ratio') + xlab('Age') + 
  scale_x_continuous(breaks=10*(0:10)) +
  theme_bw() + scale_y_log10() +
  theme(text=element_text(size=14))
```

Clearly, these different approaches would result in different mortality outcomes for otherwise identical infection patterns. Here's how you can use `YLLr` to get properly age-weighted aggregate parameters:

```{r}
uk <- YLLr::aggregate_param(ifr_levin,
                      model_agegrps,
                      data.table(lower=c(5*0:20),
                                 upper=c(5*1:20-1, 120),
                                 pop=epi_data[grepl('United Kingdom',name)]$value))
afg <- YLLr::aggregate_param(ifr_levin,
                      model_agegrps,
                      data.table(lower=c(5*0:20),
                                 upper=c(5*1:20-1, 120),
                                 pop=epi_data[grepl('Afghanistan',name)]$value))
ex_data <- ex_data[uk, on='age_group', uk_mort := agg_value]
ex_data <- ex_data[afg, on='age_group', afg_mort := agg_value]
ggplot(ex_data) + 
  geom_line(aes(age,mort_rate)) + 
  geom_line(aes(age,mort_of_mean),col=2,lty=2) + 
  geom_line(aes(age,mean_of_mort),col=3,lty=2) + 
  geom_line(aes(age,uk_mort),col=4,lty=3) + 
  geom_line(aes(age,afg_mort),col=5,lty=3) + 
  ylab('Infection fatality ratio') + xlab('Age') + 
  scale_x_continuous(breaks=10*(0:10)) +
  theme_bw() + scale_y_log10() +
  theme(text=element_text(size=14))
```

Once a model is run with the proper age-weighted parameters, you might need to disaggregate an outcome for the purposes of a follow-on analysis, such as for example converting deaths into years-life-lost. Again, let's compare a few approaches to doing such an analysis:

 - all of the deaths occur at the middle age in the group
 - the deaths are uniformly distributed within the age category
 - the deaths are proportionally distributed based on high-resolution age within the age groups
 - the deaths are proportionally distributed based both on high-resolution age *and* relative death rates

For demonstration purposes, let's assume infections that fall uniformly across the population^[More typically, the distribution of infections would reflect, for example, differing contact patterns. How the infections are actually distributed would determine the particular quantitative differences for our demonstration, but not the qualitative point.]. Then for these approaches, we get the following distribution of deaths by age:

```{r}
```

If we then combine these different deaths-by-age with life-expectancy-by-age estimates, we see these differences in estimated years-life-lost.

```{r}
```

With the `YLLr` package, we can express the higher resolution version of this calculation as:

```{r}
vals <- YLLr::disaggregate_values(...)
# combine with YLL data => result
```

In summary, properly accounting for age-specific effects requires careful bookkeeping and can result in substantively different answers. Using `YLLr` automates the bookkeeping step, so that your analyses can more easily account for potentially important differences.
